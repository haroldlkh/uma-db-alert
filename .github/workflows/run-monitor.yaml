name: Run UMA Monitor (reusable)

on:
  workflow_call:
    inputs:
      dry_run:        { type: boolean, default: false }
      sites_path:     { type: string,  required: false }
      environment_name: { type: string, required: true }
      reset_state:     { type: boolean, default: false }
      outputs_profiles:  { type: string,  required: false, default: "discord_forum" }
    secrets:
      CALLER_DISCORD_WEBHOOK_FORUM: { required: false }

jobs:
  run:
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'schedule' && vars.RUN_MONITOR == 'true') }}
    environment: ${{ inputs.environment_name }}    
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt

      - name: Prepare sites config (path > default)
        id: cfg
        run: |
          if [ -n "${{ inputs.sites_path }}" ] && [ -f "${{ inputs.sites_path }}" ]; then
            cp "${{ inputs.sites_path }}" sites.effective.yaml
          else
            cp config/sites.yaml sites.effective.yaml
          fi
          echo "sites=sites.effective.yaml" >> "$GITHUB_OUTPUT"

      # ---------- STATE CACHE (add these 3 steps) ----------
      - name: Resolve state dir (per repo + environment)
        id: st
        shell: bash
        run: |
          REPO_NS="${GITHUB_REPOSITORY//\//_}"
          ENV_NAME="${{ inputs.environment_name }}"
          DIR="$HOME/.uma_monitor/$REPO_NS/$ENV_NAME"
          echo "dir=$DIR" >> "$GITHUB_OUTPUT"
          mkdir -p "$DIR"

      - name: Restore state cache
        uses: actions/cache/restore@v4
        with:
          path: ${{ steps.st.outputs.dir }}
          key: uma-state-${{ github.repository }}-${{ inputs.environment_name }}-v1-${{ github.run_id }}
          restore-keys: |
            uma-state-${{ github.repository }}-${{ inputs.environment_name }}-v1-
      
      - name: Reset state dir (toggle)
        if: ${{ inputs.reset_state }}
        run: rm -rf ~/.uma_monitor

      - name: Set state namespace env
        run: |
          echo "UMA_ENV_NAME=${{ inputs.environment_name }}" >> $GITHUB_ENV
          # optional: pin base dir (utils will append /state)
          echo "UMA_STATE_DIR=${{ steps.st.outputs.dir }}" >> $GITHUB_ENV
      # ------------------------------------------------------

      - name: Cache Playwright browsers (optional)
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-msplaywright-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-msplaywright-

      - name: Install Playwright browsers (Chromium)
        run: python -m playwright install chromium

      - name: Resolve outputs profiles â†’ outputs.effective.yaml
        run: |
          python - <<'PY'
          import sys, yaml, os
          csv = os.environ.get("INPUTS", "discord_forum")
          names = [n.strip() for n in csv.split(",") if n.strip()]
          with open("config/output_catalogue.yaml", "r", encoding="utf-8") as f:
              catalogue = yaml.safe_load(f) or {}
          table = catalogue.get("outputs", {}) or {}
          chosen = []
          missing = []
          for n in names:
              spec = table.get(n)
              if spec: chosen.append(spec)
              else: missing.append(n)
          if missing:
              sys.stderr.write("Unknown outputs profile(s): " + ", ".join(missing) + "\n")
              sys.exit(1)
          if not chosen:
              sys.stderr.write("No outputs selected.\n"); sys.exit(1)
          with open("outputs.effective.yaml", "w", encoding="utf-8") as g:
              yaml.safe_dump({"outputs": chosen}, g, allow_unicode=True, sort_keys=False)
          print(f"Using outputs: {', '.join(names)}")
          PY
        env:
          INPUTS: ${{ inputs.outputs_profiles }}

      - name: Preflight required webhooks
        shell: bash
        run: |
          set -euo pipefail
          reqs="$(python - <<'PY'
          import yaml
          d = yaml.safe_load(open("outputs.effective.yaml","r",encoding="utf-8")) or {}
          names = []
          for o in d.get("outputs", []):
              env = (o.get("settings") or {}).get("webhook_env")
              if env: names.append(env)
          print(" ".join(sorted(set(names))))
          PY
          )"
          missing=0
          for name in $reqs; do
            # indirect expansion: ${!name} reads the env var whose name is in $name
            if [ -z "${!name:-}" ]; then
              echo "::error::Required env $name is not set (selected by outputs_profiles)"
              missing=1
            fi
          done
          [ "$missing" -eq 0 ]
      
      - name: Run orchestrator
        # env:
        #   DISCORD_WEBHOOK_FORUM: ${{ secrets.CALLER_DISCORD_WEBHOOK_FORUM }}
        run: |
          DRY=""
          if [ "${{ inputs.dry_run }}" = "true" ]; then DRY="--dry-run"; fi
          python orchestrator.py \
            --sites "${{ steps.cfg.outputs.sites }}" \
            --outputs outputs.effective.yaml \
            $DRY

      - name: Save state cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ${{ steps.st.outputs.dir }}
          key: uma-state-${{ github.repository }}-${{ inputs.environment_name }}-v1-${{ github.run_id }}
